{"pageProps":{"title":"Typecho博客加入PWA","slug":"typecho-add-pwa","created":"2020-12-18T16:05:59.009Z","modified":"2020-12-18T16:06:17.755Z","content":"\n\n## 前言\n\n这次踩了好多坑，有很多篇教程都是一样的，但是又刚刚好似乎是不适配handsome主题，总是出错。之后花了一晚上的时间和我的好朋友 **[霂森西 _ 櫻玲桉](https://dlizi.com/)** 在研究，陪着我搞了很长的时间，感谢~\n\n> 有一点请注意：使用PWA后请不要启动handsome插件自带的**本地离线缓存**功能\n\n其实这个功能就是我们要弄的PWA（但今天我们不去用它）\n\n> 本文参考了https://lzw.me/a/pwa-service-worker.html\n\n## 你需要注意的Service Worker 特点\n\n- 网站**必须使用 HTTPS**。除了使用本地开发环境调试时(如域名使用 `localhost`)\n- 运行于浏览器后台，可以控制打开的作用域范围下所有的页面请求\n- 单独的作用域范围，单独的运行环境和执行线程\n- 不能操作页面 DOM。但可以通过事件机制来处理\n\n## 如何改造？\n\n参考如下步骤为你的博客快速地引入 PWA：1. 添加sw.js 2. 添加offline.html 3. manifest.jsopn 4. 引入 5. 注册sw.js\n\n### 1. 添加sw.js\n\n可以直接参考本站的sw.js https://blog.iucky.cn/sw.js\n\n之后放入网站根目录\n\n### 2. offline.html\n\n设计简单的 `offline.html` 用于离线降级显示。简单的示例参考： `https://blog.iucky.cn/offline.html`\n\n放入网站根目录\n\n### 3. manifest.json\n\n有个注意事项：\n\n需要注意的是，你需要制作一个**256\\*256及以上的ico**，不然将会出现报错，无法成功！\n\n下载本站的json并修改适合你的博客，放到站点根目录（https://blog.iucky.cn/manifest.json）\n\n\n```json\n{\n  \"scope\": \"/\",\n  \"name\": \"秉松博客\",\n  \"short_name\": \"秉松博客\",\n  \"start_url\": \"/\",\n  \"display\": \"standalone\",\n  \"description\": \"有秉性正直的松\",\n  \"dir\": \"rtl\",\n  \"lang\": \"cn\",\n  \"orientation\": \"portrait\",\n  \"theme_color\": \"#fff\",\n  \"background_color\": \"#fff\",\n    \"icons\": [\n        {\n            \"src\": \"https://blog.iucky.cn/favicon-1.ico\",\n            \"sizes\": \"64x64\",\n            \"type\": \"image/png\"\n        },\n        {\n            \"src\": \"https://blog.iucky.cn/favicon-1.ico\",\n            \"sizes\": \"120x120\",\n            \"type\": \"image/png\"\n        },\n        {\n            \"src\": \"https://blog.iucky.cn/favicon-1.ico\",\n            \"sizes\": \"144x144\",\n            \"type\": \"image/png\"\n        },\n        {\n            \"src\": \"https://blog.iucky.cn/favicon-1.ico\",\n            \"sizes\": \"152x152\",\n            \"type\": \"image/png\"\n        },\n        {\n            \"src\": \"https://blog.iucky.cn/favicon-1.ico\",\n            \"sizes\": \"192x192\",\n            \"type\": \"image/png\"\n        },\n        {\n            \"src\": \"https://blog.iucky.cn/favicon-1.ico\",\n            \"sizes\": \"384x384\",\n            \"type\": \"image/png\"\n        },\n        {\n            \"src\": \"https://blog.iucky.cn/favicon-1.ico\",\n            \"sizes\": \"512x512\",\n            \"type\": \"image/png\"\n        }\n    ]\n}\n\n```\n\n### 引入文件以及载入支持\n\n将下面代码放至`自定义输出head 头部的HTML代码`\n\n```html\n<!--PWA（manifest必须加载）-->\n<link rel=\"manifest\" href=\"/manifest.json\">\n<!--PWA（为iOS和Windows10载入支持）-->\n<meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n<meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black\">\n<meta name=\"apple-mobile-web-app-title\" content=\"秉松博客\">\n<link rel=\"apple-touch-icon\" href=\"https://blog.iucky.cn/favicon-1.ico\">\n<meta name=\"msapplication-TileImage\" content=\"https://blog.iucky.cn/favicon-1.ico\">\n<meta name=\"msapplication-TileColor\" content=\"#fff\">\n<!--PWA End-->\n```\n\n   \n\n### 注册sw.js\n\n将下面的代码放入`自定义输出body 尾部的HTML代码`\n\n注意先知：\n\n请注意，这串代码中，你需要**修改一处地方**，自己从代码里找下吧\n\n\n```html\n<script>\n// 注册 ServiceWorker\nfunction regSW() {\n    if ('serviceWorker' in navigator) {\n        // 注册\n        navigator.serviceWorker\n            .register('/sw.js', {scope: '/'})\n            .then( function(registration) {\n                console.log('ServiceWorker 注册成功！作用域为: ', registration.scope);\n            })\n            .catch(function(err) {\n                console.log('ServiceWorker 注册失败: ', err);\n            });\n \n        // SW 消息处理\n        navigator.serviceWorker.ready.then(function(reg) {\n            if (!window.Notification || !window.MessageChannel) {\n                return;\n            }\n \n            // 建立一个消息管道，用于当前页面与 SW 之间的消息传递，也便于 SW 知道该消息的来源\n            var channel = new window.MessageChannel();\n \n            channel.port1.onmessage = function(e) {\n                console.log('get Message: ', e.data);\n                if (!e.data) {\n                    return;\n                }\n \n                // 要求申请通知权限\n                if (e.data.type === 'applyNotify') {\n                    window.Notification.requestPermission().then(function(grant) {\n                        if (grant !== 'granted') {\n                            console.log('申请通知权限被拒绝了！')\n                            return;\n                        }\n \n                        reg.active.postMessage({type: 'notify', info: e.data.info}, [channel.port2]);\n                    });\n                }\n            }\n \n            reg.active.postMessage('hello', [channel.port2]);\n        });\n \n        // 掉线通知示例\n        $(window).on('offline', function() {\n            Notification.requestPermission().then(function (grant) {\n                if (grant !== 'granted') {\n                    return;\n                }\n \n                var notification = new Notification(\"Hi，网络不给力哟\", {\n                    body: '您的网络貌似离线了，不过在秉松博客里访问过的页面还可以继续打开~',\n                    icon: 'https://kyun.ltyuanfang.cn/tc/2020/07/30/9b5b630e9860b.png'\n                });\n \n                notification.onclick = function() {\n                    notification.close();\n                };\n            });\n        })\n    }\n}\nregSW();\n</script>\n```\n\n最后，刷新下浏览器缓存，就可以看到效果啦！！\n\n> 成功了的话可以在评论区和我说说呀\n\n## 最后效果\n![](https://kyun.ltyuanfang.cn/tc/2020/11/08/85eae916ec4c0.jpg)"},"__N_SSG":true}