{"pageProps":{"title":"Typechoå®ç°çŸ­ä»£ç åŠŸèƒ½","slug":"typecho-shortcode","created":"2020-12-27T00:55:56.054Z","modified":"2020-12-27T06:57:23.417Z","content":"\n\nè¿™é‡Œç”¨å›å¤å¯è§åšğŸŒ°\n\n## æ›¿æ¢æ–‡ç« è¾“å‡º\n\nå°†post.phpä¸­çš„`<?php $this->content(); ?>`æ¢æˆ\n```php\n<?php\n$db = Typecho_Db::get();\n$sql = $db->select()->from('table.comments')\n    ->where('cid = ?',$this->cid)\n    ->where('mail = ?', $this->remember('mail',true))\n    ->where('status = ?', 'approved')\n//åªæœ‰é€šè¿‡å®¡æ ¸çš„è¯„è®ºæ‰èƒ½çœ‹å›å¤å¯è§å†…å®¹\n    ->limit(1);\n$result = $db->fetchAll($sql);\n\nif($this->user->hasLogin() || $result) {\n    $content = preg_replace(\"/\\[hide\\](.*?)\\[\\/hide\\]/sm\",'<div class=\"reply2view\">$1</div>',$this->content);\n}\nelse{\n    $content = preg_replace(\"/\\[hide\\](.*?)\\[\\/hide\\]/sm\",'<div class=\"reply2view\">æ­¤å¤„å†…å®¹éœ€è¦è¯„è®ºå›å¤åæ–¹å¯é˜…è¯»ã€‚</div>',$this->content);\n}\necho $content \n\n?>\n```\n\nå½“ç„¶ä½ ä¹Ÿå¯ä»¥åƒæˆ‘é‚£æ ·ï¼Œæ–°å»ºä¸€ä¸ªç±»ï¼Œä½¿ç”¨`<?php YourClass::Name(); ?>`\n\n```php\nclass Content{\n\n    /**\n     * æ›¿æ¢æ–‡ç« è¾“å‡ºå®ç°çŸ­ä»£ç åŠŸèƒ½\n     * Authorï¼šWibus\n     * Dateï¼š12-27\n     */\n\n    function echoSomeFunny(){\n    \n            $db = Typecho_Db::get();\n        $sql = $db->select()->from('table.comments')\n            ->where('cid = ?',$this->cid)\n            ->where('mail = ?', $this->remember('mail',true))\n            ->where('status = ?', 'approved')\n        //åªæœ‰é€šè¿‡å®¡æ ¸çš„è¯„è®ºæ‰èƒ½çœ‹å›å¤å¯è§å†…å®¹\n            ->limit(1);\n        $result = $db->fetchAll($sql);\n\n        if($this->user->hasLogin() || $result) {\n            $content = preg_replace(\"/\\[hide\\](.*?)\\[\\/hide\\]/sm\",'<div class=\"reply2view\">$1</div>',$this->content);\n        }\n        else{\n            $content = preg_replace(\"/\\[hide\\](.*?)\\[\\/hide\\]/sm\",'<div class=\"reply2view\">æ­¤å¤„å†…å®¹éœ€è¦è¯„è®ºå›å¤åæ–¹å¯é˜…è¯»ã€‚</div>',$this->content);\n        }\n        echo $content;\n    }\n}\n```\n\né‚£ä¹ˆå°±æ˜¯å°†post.phpä¸­çš„`<?php $this->content(); ?>`æ¢æˆ`<?php Content::echoSomeFunny();`\n\n## è§£å†³feedæš´éœ²\n\nè§£å†³ç¼©ç•¥å†…å®¹å’Œfeedæš´éœ²é—®é¢˜ã€‚\n\nåœ¨functions.phpä¸­åŠ å…¥å¦‚ä¸‹ä»£ç å³å¯\n```php\nTypecho_Plugin::factory('Widget_Abstract_Contents')->excerptEx = array('myyodux','one');\nTypecho_Plugin::factory('Widget_Abstract_Contents')->contentEx = array('myyodux','one');\nclass myyodux {\n    public static function one($con,$obj,$text)\n    {\n      $text = empty($text)?$con:$text;\n      if(!$obj->is('single')){\n      $text = preg_replace(\"/\\[hide\\](.*?)\\[\\/hide\\]/sm\",'',$text);\n      }\n      \n               return $text;\n}\n}\n```\n\nå°±æ˜¯ç”¨æ’ä»¶æ¥å£ï¼Œåœ¨ç¼©ç•¥å†…å®¹è¾“å‡ºä¹‹å‰ï¼Œéšè—æ‰æˆ–è€…æ›¿æ¢æ‰å›å¤å¯è§å†…å®¹ï¼ŒåŒæ—¶ä½¿ç”¨ifåˆ¤æ–­ï¼Œæ¥é’ˆå¯¹ésingleé¡µé¢è¿›è¡Œéšè—ã€‚\n\n## ä½¿ç”¨æ–¹æ³•\n\nåœ¨å†™æ–‡ç« éœ€è¦éšè—éƒ¨åˆ†å†…å®¹æ—¶ç”¨ä»¥ä¸‹å†™æ³•\n\n`[hide]è¦éšè—çš„å†…å®¹[/hide]`\n\n> ä¸è¿‡è¿™ä¸ªæ–¹æ³•ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼šä½ åªèƒ½æœ‰ä¸€ä¸ªçŸ­ä»£ç ï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°å…¶ä»–çš„æ–¹æ³•\n\n---\n\n## åç»­è§£å†³\n\nåæ¥ç¿»æ‰¾äº†ä¸€ä¸‹Wordpressç¨‹åºä»¥åŠhandsomeä¸»é¢˜ï¼Œè§£å†³äº†é—®é¢˜\n\n```php\n\n    /**\n     * çŸ­ä»£ç æ¨¡å—\n     * Authorï¼šWibus\n     * å‚ç…§é¡¹ç›®ï¼šWordpress handsome\n     * Dateï¼š2020-12-27\n     * ç›¸å…³functionï¼š\n     * get_shortcode_regexï¼Œshortcode_parse_attsï¼Œget_shortcode_atts_regexï¼Œget_markdown_regexï¼ŒscodeParseCallbackï¼ŒparseContentPublicï¼ŒpostContentï¼ŒpostContentHtml\n     */\n\n    /**\n     * è·å–åŒ¹é…çŸ­ä»£ç çš„æ­£åˆ™è¡¨è¾¾å¼\n     * Date: 2020-12-27\n     * @param null $tagnames\n     * @return string\n     * @link https://github.com/WordPress/WordPress/blob/master/wp-includes/shortcodes.php#L254\n     */\n    public static function get_shortcode_regex($tagnames = null)\n    {\n        global $shortcode_tags;\n        if (empty($tagnames)) {\n            $tagnames = array_keys($shortcode_tags);\n        }\n        $tagregexp = join('|', array_map('preg_quote', $tagnames));\n        // WARNING! Do not change this regex without changing do_shortcode_tag() and strip_shortcode_tag()\n        // Also, see shortcode_unautop() and shortcode.js.\n        // phpcs:disable Squiz.Strings.ConcatenationSpacing.PaddingFound -- don't remove regex indentation\n        return\n            '\\\\['                                // Opening bracket\n            . '(\\\\[?)'                           // 1: Optional second opening bracket for escaping shortcodes: [[tag]]\n            . \"($tagregexp)\"                     // 2: Shortcode name\n            . '(?![\\\\w-])'                       // Not followed by word character or hyphen\n            . '('                                // 3: Unroll the loop: Inside the opening shortcode tag\n            . '[^\\\\]\\\\/]*'                   // Not a closing bracket or forward slash\n            . '(?:'\n            . '\\\\/(?!\\\\])'               // A forward slash not followed by a closing bracket\n            . '[^\\\\]\\\\/]*'               // Not a closing bracket or forward slash\n            . ')*?'\n            . ')'\n            . '(?:'\n            . '(\\\\/)'                        // 4: Self closing tag ...\n            . '\\\\]'                          // ... and closing bracket\n            . '|'\n            . '\\\\]'                          // Closing bracket\n            . '(?:'\n            . '('                        // 5: Unroll the loop: Optionally, anything between the opening and closing shortcode tags\n            . '[^\\\\[]*+'             // Not an opening bracket\n            . '(?:'\n            . '\\\\[(?!\\\\/\\\\2\\\\])' // An opening bracket not followed by the closing shortcode tag\n            . '[^\\\\[]*+'         // Not an opening bracket\n            . ')*+'\n            . ')'\n            . '\\\\[\\\\/\\\\2\\\\]'             // Closing shortcode tag\n            . ')?'\n            . ')'\n            . '(\\\\]?)';                          // 6: Optional second closing brocket for escaping shortcodes: [[tag]]\n        // phpcs:enable\n    }\n    /**\n     * è·å–çŸ­ä»£ç å±æ€§æ•°ç»„\n     * Date: 2020-12-27\n     * @param $text\n     * @return array|string\n     * @link https://github.com/WordPress/WordPress/blob/master/wp-includes/shortcodes.php#L508\n     */\n    public static function shortcode_parse_atts($text)\n    {\n        $atts = array();\n        $pattern = self::get_shortcode_atts_regex();\n        $text = preg_replace(\"/[\\x{00a0}\\x{200b}]+/u\", ' ', $text);\n        if (preg_match_all($pattern, $text, $match, PREG_SET_ORDER)) {\n            foreach ($match as $m) {\n                if (!empty($m[1])) {\n                    $atts[strtolower($m[1])] = stripcslashes($m[2]);\n                } elseif (!empty($m[3])) {\n                    $atts[strtolower($m[3])] = stripcslashes($m[4]);\n                } elseif (!empty($m[5])) {\n                    $atts[strtolower($m[5])] = stripcslashes($m[6]);\n                } elseif (isset($m[7]) && strlen($m[7])) {\n                    $atts[] = stripcslashes($m[7]);\n                } elseif (isset($m[8]) && strlen($m[8])) {\n                    $atts[] = stripcslashes($m[8]);\n                } elseif (isset($m[9])) {\n                    $atts[] = stripcslashes($m[9]);\n                }\n            }\n            // Reject any unclosed HTML elements\n            foreach ($atts as &$value) {\n                if (false !== strpos($value, '<')) {\n                    if (1 !== preg_match('/^[^<]*+(?:<[^>]*+>[^<]*+)*+$/', $value)) {\n                        $value = '';\n                    }\n                }\n            }\n        } else {\n            $atts = ltrim($text);\n        }\n        return $atts;\n    }\n\n    /**\n     * Retrieve the shortcode attributes regex.\n     * Date: 2020-12-27\n     * @return string The shortcode attribute regular expression\n     * @since 4.4.0\n     *\n     */\n    public static function get_shortcode_atts_regex()\n    {\n        return '/([\\w-]+)\\s*=\\s*\"([^\"]*)\"(?:\\s|$)|([\\w-]+)\\s*=\\s*\\'([^\\']*)\\'(?:\\s|$)|([\\w-]+)\\s*=\\s*([^\\s\\'\"]+)(?:\\s|$)|\"([^\"]*)\"(?:\\s|$)|\\'([^\\']*)\\'(?:\\s|$)|(\\S+)(?:\\s|$)/';\n    }\n\n    public static function get_markdown_regex($tagName = '?')\n    {\n        return '\\\\' . $tagName . '&gt; (.*)(\\n\\n)?';\n\n    }\n\n    /**\n     * çŸ­ä»£ç è§£ææ­£åˆ™æ›¿æ¢å›è°ƒå‡½æ•°\n     * Date: 2020-12-27\n     * Style: Super_Code\n     * @param $matches\n     * @return bool|string\n     */\n    public static function scodeParseCallback($matches)\n    {\n        // ä¸è§£æç±»ä¼¼ [[player]] åŒé‡æ‹¬å·çš„ä»£ç \n        if ($matches[1] == '[' && $matches[6] == ']') {\n            return substr($matches[0], 1, -1);\n        }\n        //[scode type=\"share\"]è¿™æ˜¯ç°è‰²çš„çŸ­ä»£ç æ¡†ï¼Œå¸¸ç”¨æ¥å¼•ç”¨èµ„æ–™ä»€ä¹ˆçš„[/scode]\n        $attr = htmlspecialchars_decode($matches[3]);//è¿˜åŸè½¬ä¹‰å‰çš„å‚æ•°åˆ—è¡¨\n        $attrs = self::shortcode_parse_atts($attr);//è·å–çŸ­ä»£ç çš„å‚æ•°\n        $type = \"info\";\n        switch (@$attrs['type']) {\n            case 'yellow':\n                $type = \"Scode-Yellow\";\n                break;\n            case 'red':\n                $type = \"Scode-Red\";\n                break;\n            case 'lblue':\n                $type = \"Scode-Blue\";\n                break;\n            case 'green':\n                $type = \"Scode-Green\";\n                break;\n            case 'share':\n                $type = \"Scode-zise\";\n                break;\n            case 'pink':\n                $type = \"Scode-Pink\";\n                break;\n            case 'pink-pro':\n                $type = \"Scode-Pink-Pro\";\n                break;\n            case 'black':\n                $type = \"Scode-Black\";\n                break;\n            case 'mhz':\n                $type = \"Scode-mhz\";\n                break;\n            case 'xgh':\n                $type = \"Scode-xgh\";\n                break;\n            case 'tkzj':\n                $type = \"Scode-tkzj\";\n                break;\n            case 'xyz':\n                $type = \"Scode-xyz\";\n                break;\n            case 'gll':\n                $type = \"Scode-gll\";\n                break;\n            case 'xty':\n                $type = \"Scode-xty\";\n                break;\n            case 'Shadow':\n                $type = \"Shadow\";\n                break;\n            \n        }\n        return '<div class=\" ' . $type . '\">'.\"\\n\\n\" . $matches[5] . \"\\n\".'</div>';\n    }\n\n    /**\n     * æ–‡ç« è§£æå‡½æ•°\n     * Date: 2020-12-27\n     * @param $content\n     * @return null|string|string[]\n     */\n    public static function parseContentPublic($content)\n    {\n        //è§£æçŸ­ä»£ç åŠŸèƒ½\n        if (strpos($content, '[scode') !== false) {//æé«˜æ•ˆç‡ï¼Œé¿å…æ¯ç¯‡æ–‡ç« éƒ½è¦è§£æ\n            $pattern = self::get_shortcode_regex(array('scode'));\n            $content = preg_replace_callback(\"/$pattern/\", array('Content', 'scodeParseCallback'),\n                $content);\n        }\n        \n        return $content;\n    }\n\n    /**\n     * æ›¿æ¢+è¾“å‡ºæ–‡ç« å†…å®¹\n     * Date: 2020-12-27\n     *\n     * @param $obj\n     * @param $status\n     * @param string $way\n     * @return string\n     */\n    public static function postContent($obj, $status, $way = \"origin\")\n    {\n        if ($way == \"origin\") {\n            $content = $obj->content;\n        } else {\n            $content = $obj->content;\n\n            $content = Content::parseContentPublic($content);\n        }\n        return trim($content);\n    }\n\n    public static function postContentHtml($obj, $status)\n    {\n\n        //$way = \"origin\";\n        \n        $content = Content::postContent($obj, $status, $way);\n        \n        echo $content;\n\n    }\n```\n\nå…¶ä¸­ï¼Œget_shortcode_regexï¼Œshortcode_parse_attsï¼Œget_shortcode_atts_regexï¼Œget_markdown_regexéƒ½æ˜¯wpé‡Œçš„ä¸œè¥¿\n\nå‰©ä¸‹çš„å°±æ˜¯ç”¨æ¥æ›¿æ¢çš„äº†ï¼Œæ³¨é‡Šåº”è¯¥éƒ½å†™çš„æŒºæ¸…æ¥šçš„äº†å§ï¼Ÿ\n\n### è°ƒç”¨æ–¹æ³•\n\nå°†post.phpé‡Œçš„`<?php $this->content(); ?>`æ›¿æ¢ä¸º`<?php Content::postContentHtml($this,$this->user->hasLogin()); ?>Â·`"},"__N_SSG":true}